{% extends "layout.html" %}
{% block title %}REQUISICIONES{% endblock %}
{% block customCSS %}

<meta name="csrf-token" content="{{ csrf_token() }}">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<style>
    /* General Styles */
    body {
        background-color: #d9e3eb;
    }

    .form-container, .table-container {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid #ddd;
        margin-bottom: 20px;
    }

    .page-title {
        font-size: 24px;
        font-weight: bold;
        color: #333;
        margin-bottom: 20px;
        text-align: center;
    }

    /* Disabled Styling */
    .table-container.disabled, .botones.disabled {
        opacity: 0.5;
        pointer-events: none;
        background-color: #f0f0f0;
    }

    .botones.disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }

    /* Modal Styling */
    .modal {
        display: none;
        position: fixed;
        z-index: 1050;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .modal-content h5 {
        font-size: 20px;
        color: #333;
    }

    .modal-content p {
        font-size: 16px;
        color: #666;
        margin-bottom: 20px;
    }

    @media (max-width: 768px) {
        .col-md-6 {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block titutlo %}REQUISICIONES{% endblock %}

{% block content %}

<br>

<div class="container-fluid">

    <!-- Formulario de Requisiciones -->
    <div class="form-container needs-validation" novalidate>
        <form id="requisicionForm" onsubmit="crearRequisicion(event)">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="row">
                <div class="col-md-6">
                    <label for="nombre_proyecto">NOMBRE PROYECTO:</label>
                    <input type="text" id="nombre_proyecto" name="nombre_proyecto" class="form-control" placeholder="Buscar proyecto" required autocomplete="off">
                    <div id="projectSuggestions" class="list-group"></div>
                </div>

                <div class="col-md-6">
                    <label for="concepto">CONCEPTO:</label>
                    <input type="text" id="concepto" name="concepto" class="form-control" required>
                </div>

                <div class="col-md-6 mt-3">
                    <label for="projectLeader">LÍDER DE PROYECTO:</label>
                    <input type="text" id="projectLeader" class="form-control" readonly required>
                </div>

                <div class="col-md-6 mt-3">
                    <label for="director">DIRECTOR:</label>
                    <input type="text" id="director" class="form-control" readonly required>
                </div>

                <div class="col-md-6 mt-3">
                    <label for="requiredDate">FECHA REQUERIDA:</label>
                    <input type="date" id="requiredDate" class="form-control" name="fecha_requerida" required>
                </div>

                <div class="col-md-6 mt-3 text-center">
                    <button id="submitRequisition" class="btn botones add-row-btn" onclick="crearRequisicion(event)">ENVIAR REQUISICIÓN</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Tabla de Partidas -->
    <div class="table-container disabled">
        <button id="addRow" class="btn botones add-row-btn">AGREGAR PARTIDA</button>
        <br>
        <table class="table table-hover">
            <colgroup>
                <col style="width: 50px;">
                <col style="width: 200px;">
                <col style="width: 100px;">
                <col style="width: 100px;">
                <col style="width: 150px;">
                <col style="width: 100px;">
            </colgroup>
            <thead class="thead-dark">
                <tr>
                    <th>NO</th>
                    <th>DESCRIPCIÓN</th>
                    <th>UNIDAD</th>
                    <th>CANTIDAD</th>
                    <th>DETALLES</th>
                    <th>ACCIONES</th>
                </tr>
            </thead>
            <tbody id="requisitionTableBody"></tbody>
        </table>
    </div>
</div>

<!-- Modal for Success or Failure -->
<div id="responseModal" class="modal">
    <div class="modal-content">
        <h5 id="modalTitle"></h5>
        <p id="modalMessage"></p>
        <button id="modalCloseBtn" class="modal-close-btn" onclick="closeModal()">Aceptar</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    (() => {
        "use strict";
        const forms = document.querySelectorAll(".needs-validation");

        Array.from(forms).forEach((form) => {
            form.addEventListener("submit", (event) => {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                    Swal.fire({
                        title: "Faltan campos",
                        text: "Por favor, complete todos los campos requeridos del formulario principal.",
                        icon: "warning",
                        customClass: {
                            confirmButton: "custom-button",
                        },
                    });
                } else if (!validatePartidasPresence()) {
                    event.preventDefault();
                    Swal.fire({
                        title: "Falta Partida",
                        text: "Por favor, añade al menos una partida antes de enviar.",
                        icon: "warning",
                        customClass: {
                            confirmButton: "btn btn-warning",
                        },
                    });
                } else if (!validatePartidasFields()) {
                    event.preventDefault();
                    Swal.fire({
                        title: "Campos Faltantes en Partidas",
                        text: "Por favor, completa todos los campos en cada partida antes de enviar la requisición.",
                        icon: "warning",
                    });
                }

                form.classList.add("was-validated");
            }, false);
        });
    })();

    let isSubmitting = false;
    let rowCount = 1;

    document.addEventListener("DOMContentLoaded", function() {
        const projectNameInput = document.getElementById("nombre_proyecto");
        const projectSuggestions = document.getElementById("projectSuggestions");

        projectNameInput.addEventListener("input", () => {
            const query = projectNameInput.value.trim();
            if (query) {
                fetch(`/api/buscar_proyecto/?query=${query}`)
                    .then(response => response.json())
                    .then(data => {
                        projectSuggestions.innerHTML = data.map(proyecto => `
                            <a class="list-group-item list-group-item-action" style="padding: 5px;" data-project-id="${proyecto.id}">
                                ${proyecto.nombre_proyecto.trim()}
                            </a>
                        `).join("");
                        projectSuggestions.style.display = "block";
                    })
                    .catch(error => console.error("Error al buscar proyectos:", error));
            } else {
                projectSuggestions.innerHTML = "";
                projectSuggestions.style.display = "none";
            }
        });

        projectSuggestions.addEventListener("click", (event) => {
            const suggestion = event.target;
            if (suggestion.matches(".list-group-item")) {
                const requisicionId = suggestion.dataset.projectId;
                projectNameInput.value = suggestion.textContent.trim();
                projectSuggestions.style.display = "none";

                fetch(`/api/get_project_details/${requisicionId}`)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById("projectLeader").value = data.lider_proyecto || "";
                        document.getElementById("director").value = data.director_proyecto || "";
                        enableForm();
                    })
                    .catch(error => console.error("Error al obtener detalles del proyecto:", error));
            }
        });

        document.getElementById("addRow").addEventListener("click", addRequisitionRow);
    });

    function enableForm() {
        document.getElementById("submitRequisition").classList.remove("disabled");
        document.querySelector(".table-container").classList.remove("disabled");
    }

    function crearRequisicion(event) {
        event.preventDefault();

        const nombreProyecto = document.getElementById("nombre_proyecto").value.trim();
        const concepto = document.getElementById("concepto").value.trim();
        const requiredDate = document.getElementById("requiredDate").value.trim();

        if (!nombreProyecto || !concepto || !requiredDate) {
            Swal.fire({
                title: "Campos Faltantes",
                text: "Por favor, completa todos los campos obligatorios antes de enviar.",
                icon: "warning"
            });
            return;
        }

        if (!validatePartidasPresence() || !validatePartidasFields()) {
            Swal.fire({
                title: "Error en Partidas",
                text: "Asegúrate de que al menos una partida esté completa y que todos los campos de cada partida estén llenos.",
                icon: "warning"
            });
            return;
        }

        if (isSubmitting) return;
        isSubmitting = true;

        const data = {
            nombre_proyecto: nombreProyecto,
            concepto: concepto,
            fecha_requerida: requiredDate,
            status: 0
        };

        fetch('/api/nueva_requisicion', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            Swal.fire({
                title: "Requisición Exitosa",
                text: data.message || "Requisición creada exitosamente",
                icon: "success",
                customClass: {
                    confirmButton: "custom-button"
                }
            }).then(() => {
                enviarPartidas(data.id);
            });
        })
        .catch(error => {
            Swal.fire({
                title: "Error",
                text: "Ocurrió un error al crear la requisición",
                icon: "error"
            });
        })
        .finally(() => {
            isSubmitting = false;
        });
    }

    function enviarPartidas(id_requisicion) {
    const filas = document.querySelectorAll("#requisitionTableBody tr");
    const partidas = [];
    let allFieldsFilled = true;

    filas.forEach(fila => {
        const descripcion = fila.querySelector(".descripcion").value.trim();
        const unidad = fila.querySelector(".unidad").value.trim();
        const cantidad = fila.querySelector(".cantidad").value.trim();
        const detalles = fila.querySelector(".detalles").value.trim();

        // Check if any required field in the row is empty
        if (!descripcion || !unidad || !cantidad) {
            allFieldsFilled = false;
            return;
        }

        partidas.push({
            id_requisicion: id_requisicion,
            descripcion: descripcion,
            unidad: unidad,
            cantidad: cantidad,
            detalles: detalles || "" // Default to empty string if detalles is empty
        });
    });

    if (!allFieldsFilled) {
        Swal.fire({
            title: "Error",
            text: "Por favor, completa todos los campos de cada partida antes de enviar.",
            icon: "warning"
        });
        return; // Stop submission if any row is incomplete
    }

    // Proceed with sending the partidas if all fields are filled
    fetch('/api/agregar_partida_requisicion', {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({ partidas: partidas })
    })
    .then(response => response.json())
    .then(data => {
        Swal.fire({
            title: "Partidas Enviadas",
            text: data.message || "Partidas enviadas exitosamente",
            icon: "success"
        }).then(() => {
            window.location.href = "/ConsultarRequisiciones";  // Redirect to menu after success
        });
    })
    .catch(error => {
        Swal.fire({
            title: "Error",
            text: "Ocurrió un error al enviar las partidas",
            icon: "error"
        });
    });
}


    function validatePartidasPresence() {
        const filas = document.querySelectorAll("#requisitionTableBody tr");
        return filas.length > 0;
    }

    function validatePartidasFields() {
        const filas = document.querySelectorAll("#requisitionTableBody tr");
        let allFieldsFilled = true;

        filas.forEach(fila => {
            const descripcion = fila.querySelector(".descripcion").value.trim();
            const unidad = fila.querySelector(".unidad").value.trim();
            const cantidad = fila.querySelector(".cantidad").value.trim();

            if (!descripcion || !unidad || !cantidad) {
                allFieldsFilled = false;
            }
        });

        return allFieldsFilled;
    }

    function addRequisitionRow() {
        const tableBody = document.getElementById("requisitionTableBody");
        const row = document.createElement("tr");

        row.innerHTML = `
            <td>${rowCount++}</td>
            <td>
                <input type="text" class="form-control descripcion" placeholder="Descripción" required oninput="buscarMaterial(this)">
                <div class="list-group material-suggestions"></div>
            </td>
            <td>
                <input type="text" class="form-control unidad" placeholder="Unidad" required readonly>
            </td>
            <td><input type="number" class="form-control cantidad" placeholder="Cantidad" required></td>
            <td><input type="text" class="form-control detalles" placeholder="Detalles"></td>
            <td><button type="button" class="btn btn-danger" onclick="removeRow(this)">Eliminar</button></td>
        `;
        tableBody.appendChild(row);
    }

    function buscarMaterial(input) {
        const query = input.value.trim();
        const suggestionsContainer = input.nextElementSibling;

        if (query) {
            fetch(`/api/obtener_materiales/?query=${query}`)
                .then(response => response.json())
                .then(data => {
                    suggestionsContainer.innerHTML = data.map(material => `
                        <a class="list-group-item list-group-item-action" style="padding: 5px;" 
                           data-material-id="${material.id}" data-unidad="${material.unidad_medida}">
                            ${material.nombre}
                        </a>
                    `).join("");
                    suggestionsContainer.style.display = "block";
                })
                .catch(error => console.error("Error al buscar materiales:", error));
        } else {
            suggestionsContainer.innerHTML = "";
            suggestionsContainer.style.display = "none";
        }

        suggestionsContainer.addEventListener("click", function(event) {
            if (event.target.matches(".list-group-item")) {
                input.value = event.target.textContent.trim();
                const unidadInput = input.parentNode.nextElementSibling.querySelector(".unidad");
                unidadInput.value = event.target.getAttribute("data-unidad");
                suggestionsContainer.style.display = "none";
            }
        });
    }

    function removeRow(button) {
        const row = button.parentNode.parentNode;
        row.parentNode.removeChild(row);
        rowCount--;
    }

    function getCsrfToken() {
        return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    }
</script>

{% endblock %}
