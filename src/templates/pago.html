    {% extends "layout.html" %}
    {% block title %}Consultar Asistencia{% endblock %}
    {% block customCSS %}

    <meta name="csrf-token" content="{{ csrf_token() }}">
    <style>

        .table-container table {
            table-layout: auto; /* Permite que las columnas se ajusten autom치ticamente */
            width: 100%; /* La tabla ocupar치 todo el ancho disponible */
        }

        .table-container th, .table-container td {
            word-wrap: break-word; /* Ajusta el texto a la siguiente l칤nea si es necesario */
            white-space: normal; /* Permite que el texto se envuelva */
            vertical-align: middle; /* Alinea verticalmente el contenido al centro */
            text-align: center; /* Centra el texto horizontalmente */
            padding: 5px; /* A침ade un poco de espacio alrededor del texto */
        }
        .header-container {
        display: flex;
        justify-content: space-between; /* Para distribuir los elementos */
        align-items: center;
        margin-bottom: 20px;
        padding: 10px 20px; /* Reducir el relleno */
        background-color: #f8f9fa;
        border-radius: 4px; /* Bordes menos redondeados */
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); /* Reducir la sombra */
        width: 100%; /* Ocupa todo el ancho */
        max-width: 100%; /* Sin l칤mite de ancho */
        margin: 0 auto 20px;
        gap: 10px;
    }

    .week-selector {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 5px; /* Espaciado m치s compacto */
    }

    .week-selector button {
        background-color: #0f2d3a;
        color: white;
        border: none;
        padding: 6px 12px; /* Botones m치s peque침os */
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px; /* Texto m치s peque침o */
        font-weight: bold;
    }

    .week-selector button:hover {
        background-color: white;
        color: #0f2d3a;
        border: 1px solid #0f2d3a;
    }

    .week-selector span {
        font-size: 14px; /* Texto m치s peque침o */
        font-weight: bold;
    }

    .export-button {
        background-color: #0f2d3a;
        color: white;
        border: none;
        padding: 8px 16px; /* Bot칩n m치s compacto */
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px; /* Texto m치s peque침o */
        font-weight: bold;
    }

    .export-button:hover {
        background-color: white;
        color: #0f2d3a;
        border: 1px solid #0f2d3a;
    }

    #projectInput {
        padding: 6px; /* Input m치s peque침o */
        border-radius: 4px;
        border: 1px solid #ddd;
        max-width: 300px; /* Input m치s corto */
    }
        #map {
            width: 100%;
            height: 300px; /* Ajusta seg칰n tu dise침o */
            margin-top: 10px;
        }
        
    /* Estilo general para inputs, selects y textareas */
    input, select, textarea {
        text-transform: uppercase; /* Convertir texto a may칰sculas */
        font-family: Arial, sans-serif; /* Fuente est치ndar para legibilidad */
        font-size: 14px; /* Tama침o de fuente */
        padding: 8px; /* Espaciado interno */
        border: 1px solid #ccc; /* Borde est치ndar */
        border-radius: 4px; /* Bordes redondeados */
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1); /* Sombra interna */
        width: 100%; /* Ocupa todo el ancho disponible */
        max-width: 400px; /* Ancho m치ximo */
    }

    /* Cambios al enfocar */
    input:focus, select:focus, textarea:focus {
        border-color: #007bff; /* Borde azul */
        box-shadow: 0 0 5px rgba(0, 123, 255, 0.5); /* Sombra azul */
        outline: none; /* Quitar el borde azul por defecto */
    }

    /* Placeholder en may칰sculas (para navegadores compatibles) */
    ::placeholder {
        text-transform: uppercase;
        color: #aaa; /* Color gris claro */
    }

    /* Estilo deshabilitado */
    input:disabled, select:disabled, textarea:disabled {
        background-color: #f8f9fa; /* Fondo gris claro */
        color: #6c757d; /* Texto gris */
        cursor: not-allowed; /* Cursor no permitido */
    }

    /* Botones dentro de formularios */
    button {
        text-transform: uppercase; /* Convertir texto a may칰sculas */
        font-size: 14px;
        font-weight: bold;
        padding: 8px 16px;
        background-color: #007bff; /* Azul predeterminado */
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    button:hover {
        background-color: #0056b3; /* Azul m치s oscuro */
    }
    .menu-container {
    margin-bottom: 20px;
    text-align: center;
}

.nav-tabs .nav-link {
    color: #fff; /* Texto blanco */
    background-color: #0f2d3a; /* Fondo azul oscuro */
    font-weight: bold;
    font-size: 14px;
    border: none; /* Sin bordes */
    padding: 10px 20px; /* Ajustar tama침o */
}

.nav-tabs .nav-link.active {
    background-color: #fff; /* Fondo blanco para la activa */
    color: #0f2d3a; /* Texto azul oscuro */
    border: 1px solid #0f2d3a; /* Borde para destacar */
}

.nav-tabs .nav-link:hover {
    background-color: #f8f9fa; /* Fondo gris claro en hover */
    color: #0f2d3a; /* Texto azul oscuro */
}
    </style>

    {% endblock %}

    {% block titutlo %}S츼BANA DE ASISTENCIA{% endblock %}

    {% block content %}
    <div class="container-fluid">
        <br>
        <header class="header-container">
            <!-- Informaci칩n del proyecto -->
            <div class="project-info">
                <h4 id="projectName">Obra:</h4>
                <div>
                    <input type="text" id="projectInput" class="form-control" placeholder="Buscar proyecto..." />
                </div>
                <p><strong>L칤der de Proyecto:</strong> <span id="projectLeader">N/A</span></p>
                <p><strong>Periodo:</strong> <span id="projectPeriodo">N/A</span></p>
                <p><strong>Horario:</strong> <span id="projectSchedule">N/A</span></p>
                <!-- Selector de semanas -->
                <div class="week-selector">
                    <button id="prevWeek" class="nav-button">Semana Anterior</button>
                    <span id="currentWeek">21 Nov. 2024 - 25 Nov. 2024</span>
                    <button id="nextWeek" class="nav-button">Semana Siguiente</button>
                </div>
            </div>
            
            
        
            <!-- Botones de acci칩n -->
            <div class="action-buttons">
                <button id="exportExcel" class="export-button">Exportar a Excel</button>
            </div>
        </header>
        

<div class="menu-container">
    <nav class="nav nav-tabs">
        <a class="nav-link {{ 'active' if request.path == '/sabanaasistencias2' else '' }}" href="/sabanaasistencias2">Asistencias</a>
        <a class="nav-link {{ 'active' if request.path == '/sabanaasistencias3' else '' }}" href="/sabanaasistencias3">Pagos</a>
        <a class="nav-link {{ 'active' if request.path == '/sabanaasistencias4' else '' }}" href="/sabanaasistencias4">DISPERSION MONEDERO</a>
        <a class="nav-link {{ 'active' if request.path == '/sabanaasistencias5' else '' }}" href="/sabanaasistencias5">DISPERSION IMSS</a>
    </nav>
</div>

<div id="mensajeSeleccion" class="text-center" style="display: none; padding: 20px; font-size: 18px;">
    <p><strong>Selecciona un proyecto por favor</strong></p>
</div>


<div class="table-container" id="tablaPrint">
    <div id="tablaAsistenciaContainer" class="table-container" style="display: none;">
        <table class="table table-hover" id="tablaPago">
            
            <thead class="table-dark">
                <tr>
                    <th scope="col" colspan="6">Datos Generales</th>
                    <th scope="col"></th> <!-- Espacio en blanco -->
                    <th scope="col" colspan="4">Pago IMSS</th>
                    <th scope="col"></th> <!-- Espacio en blanco -->
                    <th scope="col" colspan="3">Pago Monedero</th>
                    <th scope="col"></th> <!-- Espacio en blanco -->
                    <th scope="col">N칩mina Total</th>
                </tr>
                <tr>
                    <th scope="col">No.</th>
                    <th scope="col">C칍DIGO</th>
                    <th scope="col">ID</th>
                    <th scope="col">NOMBRE</th>
                    <th scope="col">CATEGOR칈A</th>
                    <th scope="col">PAGO NETO SEMANAL</th>
                    <th scope="col"></th> <!-- Espacio en blanco -->
                    <th scope="col">NETO</th>
                    <th scope="col">IMSS</th>
                    <th scope="col">INFONAVIT</th>
                    <th scope="col">TOTAL</th>
                    <th scope="col"></th> <!-- Espacio en blanco -->
                    <th scope="col">NETO</th>
                    <th scope="col">COMISI칍N</th>
                    <th scope="col">TOTAL</th>
                    <th scope="col"></th> <!-- Espacio en blanco -->
                    <th scope="col">TOTAL</th>
                </tr>
            </thead>
            <tbody id="tablaPagos">
                <!-- Aqu칤 se inyectar치n los datos din치micamente -->
            </tbody>
        </table>
    </div>
</div>

        
    </div>

    <!-- Modal -->
    <div class="modal fade" id="asistenciaModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">Detalles de Asistencia</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">

                    <p><strong>Empleado:</strong> <span id="modalEmpleado"></span></p>
                    <p><strong>D칤a:</strong> <span id="modalDia"></span></p>
                    <p><strong>Hora de Entrada:</strong> <span id="modalEntrada"></span></p>
                    <p><strong>Hora de Salida:</strong> <span id="modalSalida"></span></p>
                    <div id="modalFotoContainer">
                        <h5>Foto de Asistencia</h5>
                        <div id="modalFoto" style="text-align: center; margin-top: 10px;">
                            <!-- Aqu칤 se mostrar치 din치micamente la foto -->
                        </div>
                    </div>
                    <h5>Ubicaci칩n</h5>
                    <div id="map"></div>

                    <!-- Nuevo input para capturar horas extra -->
                <!-- Nuevo input para capturar horas extra -->
<div class="form-group">
    <label for="horasExtra">Horas Extra:</label>
    <input type="time" id="horasExtra" class="form-control" step="900" 
           title="Selecciona las horas extra trabajadas (HH:MM)">
    <button id="registrarHorasExtra" class="btn btn-primary">Registrar</button>
</div>
                </div>           
            </div>
        </div>
    </div>

    <!-- Modal para Registro de Incidencia -->
<div class="modal fade" id="incidenciaModal" tabindex="-1" aria-labelledby="incidenciaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="incidenciaModalLabel">Registro de Incidencia</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="incidenciaForm" method="POST" novalidate>
                    <!-- CSRF Token -->
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <!-- Campo oculto para el ID del empleado -->
                    <input type="hidden" id="idEmpleado" name="idEmpleado" required>

                    <div class="form-group">
                        <label for="employeeName">Nombre del Empleado:</label>
                        <input type="text" id="employeeName" class="form-control" placeholder="Buscar empleado" autocomplete="off" required>
                        <div id="employeeSuggestions" class="list-group"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="tipoIncidencia">Tipo de Incidencia:</label>
                        <select id="tipoIncidencia" name="tipoIncidencia" class="form-control" required>
                            <option value="" disabled selected>-----Seleccione una Opci칩n-----</option>
                            <option value="A">Asistencia</option>
                            <option value="F">Falta</option>
                            <option value="I">Incapacidad</option>
                            <option value="V">Vacaciones</option>
                            <option value="DT">Descanso Trabajado</option>
                            <option value="PCG">Permiso con Goce</option>
                            <option value="PSG">Permiso sin Goce</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="fechaInicial">Fecha Inicial:</label>
                        <input type="date" id="fechaInicial" name="fechaInicial" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label for="fechaFinal">Fecha Final:</label>
                        <input type="date" id="fechaFinal" name="fechaFinal" class="form-control">
                    </div>

                    <div class="form-group">
                        <label for="diasSolicitados">D칤as Solicitados:</label>
                        <input type="number" id="diasSolicitados" name="diasSolicitados" class="form-control" required readonly>
                    </div>

                    <div class="form-group">
                        <label for="comentarios">Comentarios:</label>
                        <textarea id="comentarios" name="comentarios" class="form-control" rows="3" placeholder="Comentarios adicionales"></textarea>
                    </div>

                    <div class="text-center">
                        <button type="submit" class="btn btn-primary" id="submitIncidencia">Registrar Incidencia</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

    <script>
        
        // Declaraci칩n de variables globales
        let currentStartDate = new Date(2024, 11, 2); // Lunes, 2 de diciembre de 2024
        let currentProjectId = null; // Proyecto seleccionado (se inicializa como null)
        let map, marker;
        let selectedEmployeeId = null; // Variable global para guardar el ID del empleado seleccionado

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
      
document.getElementById("registrarHorasExtra").addEventListener("click", async () => {
    const horasExtraInput = document.getElementById("horasExtra").value; // Captura el valor del input
    const horasExtraDecimal = convertirHorasExtra(horasExtraInput); // Convierte a decimal

    if (!horasExtraDecimal || horasExtraDecimal <= 0) {
        alert("Por favor, selecciona una cantidad v치lida de horas extra.");
        return;
    }

    // Obtener el nombre del empleado desde el modal
    const empleadoNombre = document.getElementById("modalEmpleado").textContent.trim();
    
    // Verificar si ya tenemos el ID en el bot칩n o buscarlo si no existe
    let empleadoId = document.getElementById("modalEmpleado").dataset.empleadoId;

    if (!empleadoId) {
        empleadoId = await fetchEmpleadoId(empleadoNombre);
    }

    if (!empleadoId) {
        alert("No se pudo obtener el ID del empleado. Verifica los datos.");
        return;
    }

    const fechaOriginal = document.getElementById("modalDia").textContent.trim();
    const fecha = new Date(fechaOriginal).toISOString().split("T")[0]; // Formato YYYY-MM-DD

    try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        const response = await fetch('/api/modificar_horas_extra', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken // Incluir el CSRF token aqu칤
            },
            body: JSON.stringify({
                id_empleado: empleadoId,
                fecha: fecha,
                horas_extra: horasExtraDecimal
            })
        });

        if (response.ok) {
            const result = await response.json();
            alert(result.mensaje || "Horas extra actualizadas exitosamente.");
            // Opcional: recargar datos o actualizar tabla
            await cargarAsistencias(currentStartDate, currentProjectId);
        } else {
            const error = await response.json();
            alert(error.error || "Error al actualizar las horas extra.");
        }
    } catch (error) {
        console.error("Error al registrar horas extra:", error);
        alert("Hubo un problema al registrar las horas extra. Intenta nuevamente.");
    }
});

        // Obtener rango de fechas (7 d칤as)
        function getWeeklyDates(startDate) {
                const dates = [];
                for (let i = 0; i < 7; i++) {
                    const date = new Date(startDate);
                    date.setDate(startDate.getDate() + i);
                    

                    const options = { 
                        year: 'numeric', 
                        month: '2-digit', 
                        day: '2-digit' 
                    };
                    const formattedDate = date.toLocaleDateString('en-GB', options).split('/').reverse().join('-');
                    
                    dates.push(formattedDate); // Formato YYYY-MM-DD
                }
                return dates;
            }

    // Asignar din치micamente las fechas a los d칤as de la tabla
    function assignDatesToTable() {
        // Obtener las fechas de la semana actual
        const weeklyDates = getWeeklyDates(currentStartDate);

        // Simular columnas en la tabla (lunes a domingo)
        const daysOfWeek = ["LUNES", "MARTES", "MI칄RCOLES", "JUEVES", "VIERNES", "S츼BADO", "DOMINGO"];
        const table = {}; // Para almacenar la asignaci칩n (simula las filas de la tabla)

        daysOfWeek.forEach((day, index) => {
            // Asignar la fecha respectiva a cada d칤a
            table[day] = weeklyDates[index];
        });

        // Imprimir las asignaciones en la consola
        console.log("Asignaci칩n de fechas por d칤a:");
        console.table(table);

        // Simular a침adirlo a la tabla (ejemplo: asociar a botones o elementos DOM)
        document.querySelectorAll(".asistencia-btn").forEach((btn, index) => {
            if (index < 7) { // Asignar solo si hay suficientes d칤as
                btn.setAttribute("data-fecha", weeklyDates[index]);
                console.log(`Asignado: ${daysOfWeek[index]} -> ${weeklyDates[index]}`);
            }
        });
    }

    // Ejecutar el script
    assignDatesToTable();
        // Ajustar el inicio de la semana a lunes
        function getStartOfWeek(date) {
            const day = date.getDay(); // 0 = Domingo, 1 = Lunes, ..., 6 = S치bado
            const diff = day === 0 ? -6 : 1 - day; // Si es domingo, retrocede 6 d칤as; si no, ajusta a lunes
            const startOfWeek = new Date(date);
            startOfWeek.setDate(date.getDate() + diff);
            return startOfWeek;
        }

        // Formatear fecha en formato YYYY-MM-DD y ajustar a la zona horaria local
        function formatDate(date) {
                const options = { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit' 
                };
                
                // Obtener la fecha local ajustada a la zona horaria
                const localDate = new Date(date);
                const formattedDate = localDate.toLocaleDateString('en-GB', options).split('/').reverse().join('-');

                return formattedDate; // Retornar la fecha en formato YYYY-MM-DD
            }

        // Inicializar el mapa con coordenadas espec칤ficas
        function initMap(lat, lng) {
            const location = { lat: parseFloat(lat), lng: parseFloat(lng) };
            const mapOptions = {
                center: location,
                zoom: 15,
            };

            if (!map) {
                map = new google.maps.Map(document.getElementById("map"), mapOptions);
                marker = new google.maps.Marker({
                    position: location,
                    map: map,
                });
            } else {
                map.setCenter(location);
                marker.setPosition(location);
            }
        }

        // Actualizar el rango de fechas en el encabezado
        function updateWeekDisplay(startDate) {
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6); // Incrementar 6 d칤as para incluir el domingo
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            document.getElementById("currentWeek").textContent = `${startDate.toLocaleDateString('es-ES', options)} - ${endDate.toLocaleDateString('es-ES', options)}`;
        }

        function procesarIncidencias(incidencias) {
            // Inicializar un objeto para contar incidencias por tipo
            const conteoIncidencias = {};

            Object.entries(incidencias).forEach(([empleadoId, empleado]) => {
                const { nombre_empleado, incidencias: incidenciasPorDia } = empleado;

                // Buscar la fila correspondiente al empleado en la tabla
                document.querySelectorAll("#tablaAsistencia tr").forEach(fila => {
                    const nombreCelda = fila.querySelector("td:first-child");

                    if (nombreCelda && nombreCelda.textContent.trim() === nombre_empleado) {
                        // Iterar sobre las incidencias por d칤a
                        Object.entries(incidenciasPorDia).forEach(([fecha, incidencia]) => {
                            const diaSemana = (new Date(fecha).getDay() + 1) % 7; // Ajustar para considerar Domingo como 칰ltimo d칤a

                            if (diaSemana >= 1 && diaSemana <= 7) { // Ignorar Domingo (0)
                                const celdaDia = fila.querySelectorAll("td")[diaSemana];

                                if (celdaDia) {
                                    const boton = celdaDia.querySelector("button");
                                    if (boton) {
                                        // Actualizar contenido y estilo del bot칩n
                                        const tipoIncidencia = incidencia.tipo_incidencia || "I"; // Por defecto "I" si no est치 definido
                                        boton.textContent = tipoIncidencia;
                                        boton.style.backgroundColor = "#fff3cd"; // Amarillo claro
                                        boton.style.color = "#856404"; // Marr칩n oscuro
                                        boton.title = incidencia.comentarios || "Sin comentarios";

                                        // Incrementar el conteo del tipo de incidencia
                                        conteoIncidencias[tipoIncidencia] = (conteoIncidencias[tipoIncidencia] || 0) + 1;
                                    }
                                }
                            }
                        });
                    }
                });
            });

            // Mostrar el conteo de incidencias en la consola
            console.log("Conteo de incidencias por tipo en la semana:", conteoIncidencias);
        }

        async function cargarIncidencias(startDate) {
    const endDate = new Date(startDate);
    endDate.setDate(startDate.getDate() + 6); // Calcular el rango hasta el domingo

    const url = `/api/incidencias_rango?fecha_inicio=${formatDate(startDate)}&fecha_fin=${formatDate(endDate)}`;

    try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`Error al consultar incidencias: ${response.statusText}`);
        }

        const incidencias = await response.json();

        // Procesar y renderizar las incidencias en la tabla
        

        // Colorear las celdas en la tabla bas치ndote en las incidencias
        procesarIncidencias(incidencias);

        return incidencias; // Retornar incidencias por si es necesario para otro procesamiento
    } catch (error) {
        console.error("Error al cargar incidencias:", error);
        return []; // En caso de error, retornar un arreglo vac칤o
    }
}


// Funci칩n para calcular los totales de un empleado
function calcularTotalesEmpleado(empleado, nominaSemanal, rowElement = null) {
    const sueldoDiario = nominaSemanal / 7; // Calcular sueldo diario

    // Calcular los d칤as asistidos considerando DT como doble
    const diasAsistidos = ["Lunes", "Martes", "Mi칠rcoles", "Jueves", "Viernes", "S치bado", "Domingo"]
        .reduce((total, dia) => {
            const estado = empleado[dia]?.estado;
            if (estado === "A" || estado === "I" || estado === "PCG") {
                return total + 1; // Asistencia normal cuenta como 1
            } else if (estado === "DT" || estado === "DF") {
                return total + 2; // D칤a doble cuenta como 2
            }
            return total; // Otros estados no suman
        }, 0);

    const sueldoReal = sueldoDiario * diasAsistidos; // Calcular sueldo real basado en d칤as asistidos

    // Imprimir la diferencia entre nominaSemanal y sueldoReal
    const diferencia = sueldoReal - nominaSemanal;
    if (diferencia > 0) {
        console.log(`El sueldo real es mayor que la n칩mina semanal por ${diferencia.toFixed(2)} MXN.`);
    } else if (diferencia < 0) {
        console.log(`El sueldo real es menor que la n칩mina semanal por ${Math.abs(diferencia).toFixed(2)} MXN.`);
    } else {
        console.log("El sueldo real es igual a la n칩mina semanal.");
    }

    // Calcular faltas y su impacto
    let faltas = 0;
    let descuentoPorFaltas = 0;

    // D칤as laborales
    ["Lunes", "Martes", "Mi칠rcoles", "Jueves", "Viernes", "S치bado", "Domingo"].forEach(dia => {
        if (empleado[dia]?.estado === "F") {
            faltas++; // Contar el d칤a de la falta
            descuentoPorFaltas += sueldoDiario * (7 / 6); // Descuento por el d칤a m치s el s칠ptimo d칤a proporcional
        }
    });

    // Contar d칤as con DF y DT
    const diasDoblePago = ["Lunes", "Martes", "Mi칠rcoles", "Jueves", "Viernes", "S치bado", "Domingo"]
        .filter(dia => empleado[dia]?.estado === "DF" || empleado[dia]?.estado === "DT").length;

    // Sumar horas extra de lunes a domingo
    const horasExtra = ["Lunes", "Martes", "Mi칠rcoles", "Jueves", "Viernes", "S치bado", "Domingo"]
        .reduce((total, dia) => total + (empleado[dia]?.horas_extra || 0), 0);

    // Calcular el sueldo neto descontando las faltas
    const sueldoCalculado = nominaSemanal - descuentoPorFaltas;

    // Calcular el monto adicional por d칤as de doble sueldo
    const totalDoblePago = sueldoDiario * 2 * diasDoblePago;

    // Calcular el total por horas extra
    const valorPorHoraExtra = sueldoDiario / 8;
    const totalHorasExtra = valorPorHoraExtra * horasExtra;

    // Calcular la Prima Dominical (PD) si hay asistencia en domingo
    let primaDominical = 0;
    if (empleado.Domingo?.estado === "A") { // Verificar asistencia en domingo
        primaDominical = sueldoDiario * 0.25;
    }

    // Capturar valor del campo "Extra" si existe un rowElement asociado
    let extra = 0;
    if (rowElement) {
        const extraInput = rowElement.querySelector(".extra-input");
        if (extraInput) {
            extra = parseFloat(extraInput.value) || 0; // Asegurarse de capturar un valor num칠rico
        }
    } else {
        extra = empleado.extra || 0; // Usar el valor predeterminado si no hay input
    }

    // Capturar valor del campo "Deuda" si existe un rowElement asociado
    let deuda = 0;
    if (rowElement) {
        const deudaInput = rowElement.querySelector(".deuda-input");
        if (deudaInput) {
            deuda = parseFloat(deudaInput.value) || 0; // Asegurarse de capturar un valor num칠rico
        }
    } else {
        deuda = empleado.deuda || 0; // Usar el valor predeterminado si no hay input
    }

    // Calcular el total de n칩mina
    const totalNomina = 
        Number(sueldoReal || 0) + 
        Number(totalHorasExtra || 0) + 
        Number(primaDominical || 0) +
        Number(extra || 0) -
        Number(deuda || 0); // Restar la deuda

    // Devolver los totales como un objeto
    return {
        faltas,
        descuentoPorFaltas,
        diasDoblePago,
        totalHorasExtra,
        primaDominical,
        totalDoblePago,
        extra,
        deuda, // Incluir deuda en el objeto retornado
        sueldoReal,
        totalNomina
    };
}

function calcularPagoNetoSemanal(empleado) {
    const sueldoDiario = empleado.sueldo_base / 7; // Calcular el sueldo diario

    // Calcular los d칤as asistidos considerando estados y d칤as dobles (DT y DF)
    const diasAsistidos = ["Lunes", "Martes", "Mi칠rcoles", "Jueves", "Viernes", "S치bado", "Domingo"]
        .reduce((total, dia) => {
            const estado = empleado[dia]?.estado;
            if (estado === "A" || estado === "I" || estado === "PCG") {
                return total + 1; // D칤a normal cuenta como 1
            } else if (estado === "DT" || estado === "DF") {
                return total + 2; // D칤a doble cuenta como 2
            }
            return total; // Otros estados no suman
        }, 0);

    // Calcular el sueldo neto basado en los d칤as asistidos
    const sueldoReal = sueldoDiario * diasAsistidos;

    // Convertir el sueldo semanal a mensual
    const sueldoMensual = sueldoReal * 4.33; // Aproximadamente 4.33 semanas en un mes

    // Calcular IMSS e INFONAVIT en base al sueldo mensual
    const imssMensual = sueldoMensual * 0.253; // 25.3% del sueldo mensual
    const infonavitMensual = sueldoMensual * 0.13; // 13% del sueldo mensual

    // Convertir IMSS e INFONAVIT a semanal
    const imssSemanal = imssMensual / 4.33;
    const infonavitSemanal = infonavitMensual / 4.33;

    // Calcular la diferencia entre el sueldo real y el sueldo base
    const diferencia = sueldoReal - empleado.sueldo_base;

    // Imprimir la diferencia en la consola
    if (diferencia > 0) {
        console.log(`La diferencia es positiva: +${diferencia.toFixed(2)} MXN`);
    } else if (diferencia < 0) {
        console.log(`La diferencia es negativa: ${diferencia.toFixed(2)} MXN`);
    } else {
       
    }

    return { sueldoReal, diferencia, imssSemanal, infonavitSemanal };
}


function renderizarAsistencias(data) {
    const tabla = document.getElementById("tablaPagos");
    tabla.innerHTML = ""; // Limpiar la tabla

    data.forEach((empleado, index) => {
        const row = document.createElement("tr");

        // Obtener total de horas extra del empleado
        const totalHorasExtra = empleado.total_horas_extra || 0; // Si no tiene, poner 0

        // 游댠 Imprimir en consola para ver si est치 funcionando
        console.log(`Empleado: ${empleado.nombre_empleado}, Total Horas Extra: ${totalHorasExtra}`);

        // Calcular valores para el empleado actual
        const { sueldoReal, diferencia, imssSemanal, infonavitSemanal } = calcularPagoNetoSemanal(empleado);
        const nominaSemanal = empleado.sueldo_base || 0;
        const sueldoDiario = nominaSemanal / 7;
        const sueldoPorHora = sueldoDiario / 8;
        const topeHoras = empleado.tope_horas || 0;

        let HorasExtraEmpleado = totalHorasExtra;

        if (HorasExtraEmpleado > topeHoras) {
            HorasExtraEmpleado = topeHoras;
        }

        const MontoHorasExtra = HorasExtraEmpleado * sueldoPorHora;
        let nuevoMonedero = Number(empleado.monedero || 0) + Number(MontoHorasExtra);
        let nuevoSueldoImss = empleado.sueldo_imss || 0;

        // Ajustar el monedero seg칰n la diferencia
        if (diferencia > 0) {
            nuevoMonedero += diferencia;
        } else if (diferencia < 0) {
            if (Math.abs(diferencia) <= nuevoMonedero) {
                nuevoMonedero += diferencia;
            } else {
                nuevoMonedero = 0;
                nuevoSueldoImss = sueldoReal;
            }
        }

        const imss = nuevoSueldoImss * 0.253;
        const infonavit = nuevoSueldoImss * 0.13;
        const totalImss = Number(nuevoSueldoImss) + Number(imss) + Number(infonavit);
        const porcentajeMonedero = nuevoMonedero * 0.06;
        const totalMonedero = nuevoMonedero + porcentajeMonedero;
        const totalGeneral = totalImss + totalMonedero;

        const formatoMoneda = (valor) =>
            new Intl.NumberFormat("es-MX", {
                style: "currency",
                currency: "MXN",
            }).format(valor);

        // Renderizar la fila con los datos calculados
        row.innerHTML = `
            <td>${index + 1}</td> <!-- N칰mero -->
            <td>${empleado.codigo || "-"}</td> <!-- C칩digo -->
            <td>${empleado.id_empleado || "-"}</td> <!-- ID -->
            <td>${empleado.nombre_empleado || "-"}</td> <!-- Nombre -->
            <td>${empleado.categoria || "SIN CATEGOR칈A"}</td> <!-- Categor칤a -->
            <td>${formatoMoneda(sueldoReal + Number(MontoHorasExtra))}</td> <!-- Sueldo Real -->
            <td></td> <!-- 游댠 Nueva columna para horas extra -->
            <td>${formatoMoneda(nuevoSueldoImss)}</td> <!-- Sueldo IMSS ajustado -->
            <td>${formatoMoneda(imss)}</td> <!-- IMSS -->
            <td>${formatoMoneda(infonavit)}</td> <!-- INFONAVIT -->
            <td>${formatoMoneda(totalImss)}</td> <!-- Total IMSS -->
            <td></td>
            <td>${formatoMoneda(nuevoMonedero)}</td> <!-- Monedero ajustado -->
            <td>${formatoMoneda(porcentajeMonedero)}</td> <!-- 6% Monedero -->
            <td>${formatoMoneda(totalMonedero)}</td> <!-- Total Monedero -->
            <td></td>
            <td>${formatoMoneda(totalGeneral)}</td> <!-- Total General -->
        `;
        tabla.appendChild(row);
    });
}


async function cargarAsistencias(startDate, projectId = null) {
    const mensajeSeleccion = document.getElementById("mensajeSeleccion");
    const tablaAsistenciaContainer = document.getElementById("tablaAsistenciaContainer");

    // Si no hay proyecto seleccionado, mostrar mensaje y ocultar la tabla
    if (!projectId) {
        mensajeSeleccion.style.display = "block";
        tablaAsistenciaContainer.style.display = "none";
        return;
    } else {
        mensajeSeleccion.style.display = "none";
        tablaAsistenciaContainer.style.display = "block";
    }

    const endDate = new Date(startDate);
    endDate.setDate(startDate.getDate() + 6); // Extender hasta domingo

    const url = `/api/asistencias_general2?fecha_inicio=${formatDate(startDate)}&fecha_fin=${formatDate(endDate)}${projectId ? `&id_proyecto=${projectId}` : ''}`;

    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Error al cargar asistencias: ${response.statusText}`);

        const asistencias = await response.json(); // Recibe directamente el array

        // 游댠 Validar que asistencias sea un array antes de continuar
        if (!Array.isArray(asistencias)) {
            throw new Error("La API no devolvi칩 un array v치lido de asistencias");
        }

        // 游댠 Sumar las horas extra de todos los empleados
        const totalHorasExtra = asistencias.reduce((acc, asistencia) => acc + (asistencia.total_horas_extra || 0), 0);


        // Renderizar asistencias
        renderizarAsistencias(asistencias, startDate);

        attachAsistenciaEvents(); // Agregar eventos a los botones

        // Procesar incidencias despu칠s de cargar las asistencias
        await cargarIncidencias(startDate);

    } catch (error) {
        console.error("Error al cargar asistencias:", error);
    }
}
        // Formatear asistencia en HTML
        function formatAsistencia(dia, fecha, topeHoras, horarioPersonalizadoEntrada = null, horarioPersonalizadoSalida = null) {
    if (!dia) {
        return `<button class="btn asistencia-btn" 
            data-dia="N/A"
            style="background-color: #f8d7da; color: #721c24;" 
            disabled>F</button>`;
    }

    const estado = dia.estado || "N/A";
    const esIncidencia = dia.es_incidencia === 1;
    const tipoIncidencia = dia.tipo_incidencia || null;
    let color, textColor, textoBoton;

    if (esIncidencia && tipoIncidencia) {
        color = "#cce5ff";
        textColor = "#004085";
        textoBoton = tipoIncidencia;
    } else if (estado === "A") {
        color = "#d4edda";
        textColor = "#155724";
        textoBoton = "A";
    } else if (estado === "F") {
        color = "#f8d7da";
        textColor = "#721c24";
        textoBoton = "F";
    } else if (estado === "I") {
        color = "#f8d7da";
        textColor = "#721c24";
        textoBoton = "I";
    } else if (estado === "V") {
        color = "#f8d7da";
        textColor = "#721c24";
        textoBoton = "V";
    } else if (estado === "DT") {
        color = "#f8d7da";
        textColor = "#721c24";
        textoBoton = "DT";
    } else if (estado === "PCG") {
        color = "#f8d7da";
        textColor = "#721c24";
        textoBoton = "PCG";
    } else if (estado === "PSG") {
        color = "#f8d7da";
        textColor = "#721c24";
        textoBoton = "PSG";
    } else if (estado === "DF") {
        color = "#f8d7da";
        textColor = "#721c24";
        textoBoton = "DF";
    } else {
        color = "#f8d7da";
        textColor = "#721c24";
        textoBoton = "N/A";
    }

    const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
    const localDate = new Date(fecha);
    const fechaFormatted = localDate.toLocaleDateString('en-GB', options).split('/').reverse().join('-');

    console.log(`Fecha Formateada: ${fechaFormatted}`);

    return `
        <button class="btn asistencia-btn" 
            data-dia="${dia.dia || 'N/A'}"
            data-fecha="${fechaFormatted}" 
            data-tope-horas="${dia.tope_horas_extra || 0}"  
            data-entrada="${dia.hora_entrada || '--'}"
            data-salida="${dia.hora_salida || '--'}"
            data-horario-personalizado-entrada="${horarioPersonalizadoEntrada || ''}"
            data-horario-personalizado-salida="${horarioPersonalizadoSalida || ''}"
            data-foto="${dia.foto_base64 || ''}" 
            data-lat="${dia.latitud || ''}"
            data-lng="${dia.longitud || ''}"
            style="background-color: ${color}; color: ${textColor};">
            ${textoBoton}
        </button>
    `;
}

        async function fetchEmpleadoId(nombreEmpleado) {
        try {
            const response = await fetch(`/api/buscar_empleado_nombre_apellido/?query=${encodeURIComponent(nombreEmpleado)}`);
            const empleados = await response.json();
            if (empleados.length > 0) {
                return empleados[0].id; // Retorna el ID del primer empleado encontrado
            }
            return null; // No se encontr칩 el empleado
        } catch (error) {
            console.error("Error al buscar empleado:", error);
            return null;
        }
    }



        // Agregar eventos a los botones de asistencia
        function attachAsistenciaEvents() {
    document.querySelectorAll(".asistencia-btn").forEach(button => {
        button.addEventListener("click", async function () {
            const row = this.closest("tr");
            if (!row) return;

            // Obtener el nombre del empleado de la segunda celda
            const empleadoNombre = row.querySelector("td:nth-child(2)")?.textContent.trim();

            let idEmpleado = this.getAttribute("data-empleado-id");

            if (!idEmpleado || idEmpleado === "undefined") {
                idEmpleado = await fetchEmpleadoId(empleadoNombre);
                if (!idEmpleado) {
                    alert("Empleado no encontrado en el sistema.");
                    return;
                }
            }

            // Extraer la fecha espec칤fica asignada al bot칩n
            const fechaFormatted = this.getAttribute("data-fecha");

            if (!fechaFormatted) {
                console.error("Fecha no encontrada en el bot칩n de asistencia.");
                return;
            }

            // Verificar si hay incidencia para la fecha espec칤fica
            if (
    this.textContent.trim() === "F" || // Falta
    this.textContent.trim() === "N/A" || // No aplica
    this.textContent.trim() === "I" || // Incapacidad
    this.textContent.trim() === "V" || // Vacaciones
    this.textContent.trim() === "DT" || // Descanso Trabajado
    this.textContent.trim() === "PCG" || // Permiso con Goce
    this.textContent.trim() === "PSG" // Permiso sin Goce
) {
                const incidenciaUrl = `/api/consultar_incidencia?id_empleado=${idEmpleado}&fecha=${fechaFormatted}`;
                try {
    const response = await fetch(incidenciaUrl);
    if (!response.ok) throw new Error(`Error en la consulta de incidencia: ${response.status}`);

    const incidencias = await response.json();

    if (incidencias.length > 0) {
        // Si hay incidencia, mostrar detalles en un modal
        const incidencia = incidencias[0];
        Swal.fire({
            title: "Detalles de Incidencia",
            html: `
                <p><strong>Empleado:</strong> ${empleadoNombre}</p>
                <p><strong>Fecha:</strong> ${fechaFormatted}</p>
                <p><strong>Tipo de Incidencia:</strong> ${incidencia.tipo}</p>
                <p><strong>Comentarios:</strong> ${incidencia.comentarios || "Sin comentarios"}</p>
                <p><strong>D칤as Solicitados:</strong> ${incidencia.dias_solicitados}</p>
            `,
            icon: "info",
            confirmButtonText: "Cerrar"
        });
    } else {
        // Si no hay incidencias, abrir el formulario de registro
        abrirFormularioIncidencia(empleadoNombre, idEmpleado, fechaFormatted);
    }
} catch (error) {
    console.error("Error al consultar incidencia:", error);
    Swal.fire({
        title: "Error",
        text: error.message || "Hubo un problema al consultar las incidencias. Intente nuevamente.",
        icon: "error",
        confirmButtonText: "Cerrar"
    });
}

            } else {
                // Abrir el modal de detalles de asistencia
                abrirModalDetallesAsistencia(empleadoNombre, this.getAttribute("data-dia"), this.getAttribute("data-entrada"), this.getAttribute("data-salida"), this.getAttribute("data-foto"), this.getAttribute("data-lat"), this.getAttribute("data-lng"));
            }
        });
    });
}


    // Funci칩n para buscar el ID del empleado usando la API
    async function fetchEmpleadoId(nombreEmpleado) {
        try {
            const response = await fetch(`/api/buscar_empleado_nombre_apellido/?query=${encodeURIComponent(nombreEmpleado)}`);
            const empleados = await response.json();
            if (empleados.length > 0) {
                return empleados[0].id; // Retorna el ID del primer empleado encontrado
            }
            return null; // No se encontr칩 el empleado
        } catch (error) {
            console.error("Error al buscar empleado:", error);
            return null;
        }
    }

    // Funci칩n para abrir el formulario de registro de incidencia
    function abrirFormularioIncidencia(empleadoNombre, idEmpleado, fecha) {
        document.getElementById("employeeName").value = empleadoNombre || "Sin informaci칩n";
        document.getElementById("fechaInicial").value = fecha || "";
        document.getElementById("fechaFinal").value = fecha || "";
        document.getElementById("idEmpleado").value = idEmpleado || "";

        // Calcular los d칤as autom치ticamente cuando se abra el formulario
        calcularDias();

        const incidenciaModal = new bootstrap.Modal(document.getElementById("incidenciaModal"));
        incidenciaModal.show();
    }


    // Funci칩n para abrir el modal de detalles de asistencia
    function abrirModalDetallesAsistencia(empleadoNombre, dia, entrada, salida, foto, lat, lng) {
        document.getElementById("modalEmpleado").textContent = empleadoNombre || "Sin informaci칩n";
        document.getElementById("modalDia").textContent = dia || "Sin informaci칩n";
        document.getElementById("modalEntrada").textContent = entrada || "--";
        document.getElementById("modalSalida").textContent = salida || "--";

        const modalFotoContainer = document.getElementById("modalFoto");
        if (foto) {
            modalFotoContainer.innerHTML = `
                <img src="${foto.startsWith("data:image") ? foto : `data:image/png;base64,${foto}`}" 
                    alt="Foto de Asistencia" 
                    style="width: 100%; max-width: 300px; border-radius: 5px; box-shadow: 0px 2px 5px rgba(0,0,0,0.3);">
            `;
        } else {
            modalFotoContainer.innerHTML = "<p>No se registr칩 foto para esta asistencia.</p>";
        }

        if (lat && lng) {
            initMap(lat, lng); // Inicializa el mapa si hay coordenadas
        } else {
            document.getElementById("map").innerHTML = "<p>Sin ubicaci칩n disponible.</p>";
        }

        const asistenciaModal = new bootstrap.Modal(document.getElementById("asistenciaModal"));
        asistenciaModal.show();
    }



    // Funci칩n para abrir el formulario de registro de incidencia
    function abrirFormularioIncidencia(empleadoNombre, idEmpleado, fecha) {
        document.getElementById("employeeName").value = empleadoNombre || "Sin informaci칩n";
        document.getElementById("fechaInicial").value = fecha || "";
        document.getElementById("fechaFinal").value = fecha || "";
        document.getElementById("idEmpleado").value = idEmpleado || "";

        const incidenciaModal = new bootstrap.Modal(document.getElementById("incidenciaModal"));
        incidenciaModal.show();
    }

    // Funci칩n para abrir el modal de detalles de asistencia
    function abrirModalDetallesAsistencia(empleadoNombre, dia, entrada, salida, foto, lat, lng) {
        document.getElementById("modalEmpleado").textContent = empleadoNombre || "Sin informaci칩n";
        document.getElementById("modalDia").textContent = dia || "Sin informaci칩n";
        document.getElementById("modalEntrada").textContent = entrada || "--";
        document.getElementById("modalSalida").textContent = salida || "--";

        const modalFotoContainer = document.getElementById("modalFotoContainer");
        modalFotoContainer.innerHTML = foto
            ? `<img src="${foto.startsWith("data:image") ? foto : `data:image/png;base64,${foto}`}" alt="Foto de Asistencia" style="width: 100%;">`
            : "<p>Sin foto disponible</p>";

        if (lat && lng) {
            initMap(lat, lng);
        } else {
            document.getElementById("map").innerHTML = "<p>Sin ubicaci칩n disponible.</p>";
        }

        const asistenciaModal = new bootstrap.Modal(document.getElementById("asistenciaModal"));
        asistenciaModal.show();
    }

        // Configurar el autocompletado del input de proyectos
        function configurarAutocompletado() {
                const projectInput = document.getElementById("projectInput");
                const projectName = document.getElementById("projectName");

                projectInput.addEventListener("input", async (event) => {
                    const query = event.target.value.trim();
                    if (query.length < 2) return;

                    const projects = await fetch(`/api/buscar_proyecto?query=${encodeURIComponent(query)}`)
                        .then(response => response.json())
                        .catch(error => {
                            console.error("Error al buscar proyectos:", error);
                            return [];
                        });

                    const datalistId = "projectSuggestions";
                    let datalist = document.getElementById(datalistId);
                    if (!datalist) {
                        datalist = document.createElement("datalist");
                        datalist.id = datalistId;
                        document.body.appendChild(datalist);
                    }

                    datalist.innerHTML = "";
                    projects.forEach(project => {
                        const option = document.createElement("option");
                        option.value = project.nombre_proyecto;
                        option.dataset.projectId = project.id;
                        option.dataset.fechaInicio = project.fecha_inicio;  
                        option.dataset.fechaFin = project.fecha_fin;
                        option.dataset.hora_entrada = project.hora_entrada;  
                        option.dataset.hora_salida = project.hora_salida;  
                        datalist.appendChild(option);
                    });

                    projectInput.setAttribute("list", datalistId);
                });

                projectInput.addEventListener("change", () => {
                    const selectedOption = Array.from(document.querySelectorAll(`#projectSuggestions option`))
                        .find(option => option.value === projectInput.value);

                    if (selectedOption) {
                        currentProjectId = selectedOption.dataset.projectId; // Actualizar el proyecto seleccionado
                        const projectNameText = selectedOption.value;
                        projectName.textContent = projectNameText;
                        cargarAsistencias(currentStartDate, currentProjectId);
                    }
                });
            }

        document.getElementById("projectInput").addEventListener("change", function () {
    // Buscar el proyecto seleccionado en las opciones del datalist
    const selectedOption = Array.from(document.querySelectorAll(`#projectSuggestions option`))
        .find(option => option.value === this.value);

    // Si se seleccion칩 una opci칩n v치lida
    if (selectedOption) {
        // Obtener la ID y los detalles del proyecto
        const projectId = selectedOption.dataset.projectId;
        const projectName = selectedOption.value;

        // Imprimir los datos del proyecto en la consola
        console.log("Proyecto seleccionado:", projectName);
        console.log("ID del Proyecto:", projectId);

        // Aqu칤 puedes a침adir m치s detalles si necesitas imprimir m치s informaci칩n del proyecto
        // Por ejemplo, si tienes fechas asociadas al proyecto:
        const fechaInicio = selectedOption.dataset.fechaInicio;
        const fechaFin = selectedOption.dataset.fechaFin;
        const projectHoraEntrada = selectedOption.dataset.hora_entrada;
        const projectHoraSalida = selectedOption.dataset.hora_salida;
        console.log("Fecha de inicio:", fechaInicio);
        console.log("Fecha de fin:", fechaFin);

        // Ahora actualizas las partes de la UI con la informaci칩n del proyecto seleccionado
        document.getElementById("projectName").textContent = projectName;
        document.getElementById("projectPeriodo").textContent = `${fechaInicio} - ${fechaFin}`;
        document.getElementById("projectSchedule").textContent = `${(projectHoraEntrada)} - ${(projectHoraSalida)}`;
    } else {
        console.log("No se seleccion칩 un proyecto v치lido.");
    }
});

        // Exportar a Excel
        document.getElementById("exportExcel").addEventListener("click", function () {
        const table = document.getElementById("tablaPrint");

        // Extraer encabezados (ignorando la primera fila de encabezado)
        const headers = Array.from(table.querySelectorAll("thead tr:nth-child(2) th")).map(th => th.textContent.trim());

        // Extraer las filas de datos
        const rows = Array.from(table.querySelectorAll("tbody tr")).map(row => {
            return Array.from(row.querySelectorAll("td")).map(td => td.textContent.trim());
        });

        // Obtener informaci칩n adicional
        const projectName = document.getElementById("projectName").textContent.trim() || 'Todos los proyectos';
        const dateRange = document.getElementById("currentWeek").textContent.trim() || 'Rango no especificado';

        // Validar que no est칠n vac칤os
        if (!headers.length || !rows.length) {
            alert("No hay datos para exportar.");
            console.error("Headers o filas vac칤os.");
            return;
        }



        // Recuperar el CSRF token
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        // Enviar datos al servidor con el CSRF token
        fetch("/exportar_excel", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken
            },
            body: JSON.stringify({
                headers,
                rows,
                project_name: projectName,  // Enviar nombre del proyecto
                date_range: dateRange       // Enviar rango de fechas
            })
        })
        .then(async response => {
            if (!response.ok) {
                const errorData = await response.json();
                console.error("Error en la respuesta del servidor:", errorData.error || response.statusText);
                throw new Error(errorData.error || "Error desconocido al generar el Excel");
            }
            return response.blob();
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "asistencia.xlsx";
            document.body.appendChild(a);
            a.click();
            a.remove();
        })
        .catch(error => {
            console.error("Error en el cliente:", error.message);
            alert(`Error al exportar el Excel: ${error.message}`);
        });
    });

        // Inicializar eventos y cargar la asistencia inicial
        document.addEventListener("DOMContentLoaded", function () {
            currentStartDate = getStartOfWeek(new Date()); // Inicializar la semana actual
            updateWeekDisplay(currentStartDate); // Actualizar encabezado de la semana
            cargarAsistencias(currentStartDate); // Cargar asistencias iniciales
            
            configurarAutocompletado();

            document.getElementById("prevWeek").addEventListener("click", () => {
    currentStartDate.setDate(currentStartDate.getDate() - 7); // Retroceder una semana
    updateWeekDisplay(currentStartDate);
    cargarAsistencias(currentStartDate, currentProjectId); // Respetar el filtro actual
    
    assignDatesToTable(); // Actualizar las fechas visibles en la tabla
});

// Bot칩n para la semana siguiente
document.getElementById("nextWeek").addEventListener("click", () => {
    currentStartDate.setDate(currentStartDate.getDate() + 7); // Avanzar una semana
    updateWeekDisplay(currentStartDate);
    cargarAsistencias(currentStartDate, currentProjectId); // Respetar el filtro actual
    
    assignDatesToTable(); // Actualizar las fechas visibles en la tabla
});
        });

        document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("incidenciaForm");
    const employeeNameInput = document.getElementById("employeeName");
    const employeeSuggestions = document.getElementById("employeeSuggestions");
    const fechaInicialInput = document.getElementById("fechaInicial");
    const fechaFinalInput = document.getElementById("fechaFinal");
    const diasSolicitadosInput = document.getElementById("diasSolicitados");

    // Funci칩n para calcular la diferencia de d칤as
    function calcularDias() {
        const fechaInicial = new Date(fechaInicialInput.value);
        const fechaFinal = new Date(fechaFinalInput.value);

        if (!isNaN(fechaInicial) && !isNaN(fechaFinal) && fechaFinal >= fechaInicial) {
            const diferenciaTiempo = fechaFinal - fechaInicial;
            const diferenciaDias = Math.ceil(diferenciaTiempo / (1000 * 60 * 60 * 24)) + 1; // +1 para incluir ambos d칤as
            diasSolicitadosInput.value = diferenciaDias; // Actualizar el campo con el total de d칤as
        } else {
            diasSolicitadosInput.value = 0; // Si no hay rango v치lido, poner 0
        }
    }

    // Actualizar el total de d칤as al cambiar las fechas
    fechaInicialInput.addEventListener("change", calcularDias);
    fechaFinalInput.addEventListener("change", calcularDias);

    // Autocompletar empleados
    employeeNameInput.addEventListener("input", async () => {
        const query = employeeNameInput.value.trim();
        if (query.length > 0) { // Buscar desde la primera letra
            try {
                const response = await fetch(`/api/buscar_empleado/?query=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error(`Error: ${response.status}`);
                const employees = await response.json();

                // Mostrar sugerencias
                employeeSuggestions.innerHTML = employees.map(emp => `
                    <a class="list-group-item list-group-item-action" data-id="${emp.id}">
                        ${emp.nombre} ${emp.apellido}
                    </a>
                `).join("");
                employeeSuggestions.style.display = "block";

                // Agregar evento de selecci칩n a cada sugerencia
                employeeSuggestions.querySelectorAll(".list-group-item").forEach(item => {
                    item.addEventListener("click", () => {
                        document.getElementById("idEmpleado").value = item.getAttribute("data-id");
                        employeeNameInput.value = item.textContent.trim();
                        employeeSuggestions.style.display = "none";
                    });
                });
            } catch (error) {
                console.error("Error al buscar empleados:", error);
                employeeSuggestions.innerHTML = `<p class="list-group-item text-danger">Error al buscar empleados</p>`;
                employeeSuggestions.style.display = "block";
            }
        } else {
            employeeSuggestions.innerHTML = "";
            employeeSuggestions.style.display = "none";
        }
    });

    // Cerrar el men칰 si haces clic fuera de 칠l
    document.addEventListener("click", (event) => {
        if (!employeeSuggestions.contains(event.target) && event.target !== employeeNameInput) {
            employeeSuggestions.style.display = "none";
        }
    });

    // Env칤o del formulario
    form.addEventListener("submit", async (event) => {
        event.preventDefault(); // Prevenir el env칤o predeterminado del formulario

        const csrfToken = document.querySelector('input[name="csrf_token"]').value; // Obtener CSRF token

        const data = {
            idEmpleado: document.getElementById("idEmpleado").value,
            tipoIncidencia: document.getElementById("tipoIncidencia").value, // Enviar치 la inicial seleccionada
            fechaInicial: document.getElementById("fechaInicial").value,
            fechaFinal: document.getElementById("fechaFinal").value || null,
            diasSolicitados: diasSolicitadosInput.value || 0,
            comentarios: document.getElementById("comentarios").value || null,
        };

        try {
            const response = await fetch('/guardar_incidencia', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken // Enviar CSRF token en el encabezado
                },
                body: JSON.stringify(data),
            });

            if (response.ok) {
                const result = await response.json();
                Swal.fire({
                    title: "칄xito",
                    text: result.message || "Incidencia registrada exitosamente.",
                    icon: "success"
                });

                // Recargar y procesar incidencias
                await cargarIncidencias(currentStartDate); // Reutilizar funci칩n existente

                form.reset();
                document.getElementById("idEmpleado").value = ""; // Limpiar el ID empleado
                diasSolicitadosInput.value = 0; // Resetear el total de d칤as
            } else {
                const error = await response.json();
                Swal.fire({
                    title: "Error",
                    text: error.error || "Error al registrar la incidencia.",
                    icon: "error"
                });
            }
        } catch (error) {
            console.error("Error al enviar el formulario:", error);
            Swal.fire({
                title: "Error",
                text: "Error al enviar el formulario. Intenta nuevamente.",
                icon: "error"
            });
        }
    });
});

 
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBNo8vETZRevilZe3c1pmM7CzrdI3VTXi0&callback=initMap"></script>
{% endblock %}
